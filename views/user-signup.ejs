<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join SkillOns - Choose Your Role</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }

        .signup-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .signup-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .signup-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .signup-body {
            padding: 2rem;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .step.active {
            background: #4f46e5;
            color: white;
        }

        .step.completed {
            background: #22c55e;
            color: white;
        }

        .step.pending {
            background: #e5e7eb;
            color: #6b7280;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .user-type-card {
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .user-type-card:hover {
            border-color: #4f46e5;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(79, 70, 229, 0.1);
        }

        .user-type-card.selected {
            border-color: #4f46e5;
            background-color: #f8faff;
        }

        .user-type-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .teacher-icon {
            color: #4f46e5;
        }

        .student-icon {
            color: #22c55e;
        }

        .form-floating > label {
            color: #6b7280;
        }

        .form-control:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 0.25rem rgba(79, 70, 229, 0.1);
        }

        .btn-primary {
            background: #4f46e5;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 10px;
            font-weight: 600;
        }

        .btn-outline-secondary {
            border-color: #d1d5db;
            color: #6b7280;
            padding: 0.75rem 2rem;
            border-radius: 10px;
            font-weight: 600;
        }

        .subdomain-preview {
            font-size: 0.9rem;
            margin-top: 0.5rem;
            font-family: 'Monaco', 'Consolas', monospace;
            color: #4f46e5;
        }

        .hero-section {
            text-align: center;
            margin-bottom: 3rem;
        }

        .hero-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .hero-subtitle {
            font-size: 1.2rem;
            color: #6b7280;
            margin-bottom: 2rem;
        }

        .plan-card {
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .plan-card:hover {
            border-color: #4f46e5;
            transform: translateY(-2px);
        }

        .plan-card.selected {
            border-color: #4f46e5;
            background-color: #f8faff;
        }

        .plan-name {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .plan-price {
            font-size: 1.5rem;
            font-weight: 600;
            color: #4f46e5;
            margin-bottom: 1rem;
        }

        .plan-features {
            list-style: none;
            padding: 0;
        }

        .plan-features li {
            padding: 0.25rem 0;
            color: #6b7280;
        }

        .plan-features li i {
            color: #22c55e;
            margin-right: 0.5rem;
        }

        .organization-form {
            display: none;
        }

        .student-form {
            display: none;
        }

        .organization-form.active,
        .student-form.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="signup-container">
        <div class="signup-card">
            <div class="signup-header">
                <h1 class="mb-0">
                    <i class="fas fa-graduation-cap me-3"></i>
                    Join SkillOns
                </h1>
                <p class="mb-0 mt-2">Choose your role to get started</p>
            </div>

            <div class="signup-body">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" id="step1">1</div>
                    <div class="step pending" id="step2">2</div>
                    <div class="step pending" id="step3">3</div>
                    <div class="step pending" id="step4">4</div>
                </div>

                <!-- Step 1: User Type Selection -->
                <div id="step1-content" class="step-content active">
                    <div class="hero-section">
                        <h2 class="hero-title">Welcome to SkillOns!</h2>
                        <p class="hero-subtitle">Are you a teacher or student?</p>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="user-type-card" id="teacher-card" onclick="selectUserType('teacher')">
                                <i class="fas fa-chalkboard-teacher user-type-icon teacher-icon"></i>
                                <h3>I'm a Teacher</h3>
                                <p class="text-muted">Create and manage quizzes, organize students, and track progress</p>
                                <ul class="list-unstyled text-start mt-3">
                                    <li><i class="fas fa-check text-success me-2"></i>Create unlimited quizzes</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Manage student groups</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Advanced analytics</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Your own organization</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="user-type-card" id="student-card" onclick="selectUserType('student')">
                                <i class="fas fa-user-graduate user-type-icon student-icon"></i>
                                <h3>I'm a Student</h3>
                                <p class="text-muted">Join your teacher's organization and take quizzes</p>
                                <ul class="list-unstyled text-start mt-3">
                                    <li><i class="fas fa-check text-success me-2"></i>Take quizzes</li>
                                    <li><i class="fas fa-check text-success me-2"></i>View study materials</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Track your progress</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Join teacher's organization</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-primary" id="userTypeNext" onclick="nextStep()" disabled>
                            Continue <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Organization Details (for teachers) / Join Organization (for students) -->
                <div id="step2-content" class="step-content">
                    <!-- Teacher Organization Form -->
                    <div class="organization-form" id="organizationForm">
                        <div class="hero-section">
                            <h2 class="hero-title">Create Your Organization</h2>
                            <p class="hero-subtitle">Set up your teaching platform</p>
                        </div>

                        <form id="step2-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="organizationName" name="organizationName" placeholder="Organization Name" required>
                                        <label for="organizationName">School/Organization Name</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="subdomain" name="subdomain" placeholder="Subdomain" required pattern="[a-z0-9-]+" maxlength="50">
                                        <label for="subdomain">Choose Your Subdomain</label>
                                    </div>
                                    <div class="subdomain-preview" id="subdomainPreview">
                                        https://your-school.skillons.com
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="teacherName" name="teacherName" placeholder="Your Name" required>
                                        <label for="teacherName">Your Full Name</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="email" class="form-control" id="email" name="email" placeholder="Email" required>
                                        <label for="email">Your Email Address</label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-floating">
                                    <textarea class="form-control" id="bio" name="bio" placeholder="Tell us about yourself" style="height: 100px"></textarea>
                                    <label for="bio">Brief Bio (Optional)</label>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Student Join Form -->
                    <div class="student-form" id="studentForm">
                        <div class="hero-section">
                            <h2 class="hero-title">Join Your Teacher's Organization</h2>
                            <p class="hero-subtitle">Enter your details and organization code</p>
                        </div>

                        <form id="student-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="studentName" name="studentName" placeholder="Your Name" required>
                                        <label for="studentName">Your Full Name</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="email" class="form-control" id="studentEmail" name="studentEmail" placeholder="Email" required>
                                        <label for="studentEmail">Your Email Address</label>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <select class="form-control" id="gradeLevel" name="gradeLevel" required>
                                            <option value="">Select Grade Level</option>
                                            <option value="1st grade">1st Grade</option>
                                            <option value="2nd grade">2nd Grade</option>
                                            <option value="3rd grade">3rd Grade</option>
                                            <option value="4th grade">4th Grade</option>
                                            <option value="5th grade">5th Grade</option>
                                            <option value="6th grade">6th Grade</option>
                                            <option value="7th grade">7th Grade</option>
                                            <option value="8th grade">8th Grade</option>
                                            <option value="9th grade">9th Grade</option>
                                            <option value="10th grade">10th Grade</option>
                                            <option value="11th grade">11th Grade</option>
                                            <option value="12th grade">12th Grade</option>
                                        <option value="Young Adult Education">Young Adult Education</option>
                                        </select>
                                        <label for="gradeLevel">Grade Level</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Organization Selection</label>
                                    <div class="mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="orgSelectMethod" id="selectFromList" value="list" checked onchange="toggleOrgSelection()">
                                            <label class="form-check-label" for="selectFromList">
                                                Select from list
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="orgSelectMethod" id="enterCode" value="code" onchange="toggleOrgSelection()">
                                            <label class="form-check-label" for="enterCode">
                                                Enter organization code manually
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-floating" id="orgSelectBox">
                                        <select class="form-control" id="organizationSelect" name="organizationCodes" multiple required style="height: 120px;">
                                            <% if (typeof organizations !== 'undefined' && organizations.length > 0) { %>
                                                <% organizations.forEach(function(org) { %>
                                                    <option value="<%= org.subdomain %>"><%= org.name %> (<%= org.subdomain %>)</option>
                                                <% }); %>
                                            <% } %>
                                        </select>
                                        <label for="organizationSelect">Choose Your Organizations (Hold Ctrl/Cmd to select multiple)</label>
                                    </div>
                                    <small class="text-muted mt-1">💡 You can select multiple organizations by holding Ctrl (Windows) or Cmd (Mac) while clicking</small>
                                    
                                    <div class="form-floating" id="orgCodeInput" style="display: none;">
                                        <input type="text" class="form-control" id="organizationCodeManual" name="organizationCodeManual" placeholder="code1, code2, code3">
                                        <label for="organizationCodeManual">Organization Codes (comma-separated)</label>
                                    </div>
                                    <small class="text-muted mt-1" id="manualCodeHelp" style="display: none;">💡 Enter multiple codes separated by commas (e.g., school1, academy2, institute3)</small>
                                    
                                    <small class="text-muted" id="orgHelpText">Select your school/organization from the list, or use the manual code option if you don't see it listed</small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Subjects of Interest (optional)</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="Math" id="subject1" name="subjects">
                                            <label class="form-check-label" for="subject1">Math</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="Science" id="subject2" name="subjects">
                                            <label class="form-check-label" for="subject2">Science</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="English" id="subject3" name="subjects">
                                            <label class="form-check-label" for="subject3">English</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="History" id="subject4" name="subjects">
                                            <label class="form-check-label" for="subject4">History</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="Geography" id="subject5" name="subjects">
                                            <label class="form-check-label" for="subject5">Geography</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="Art" id="subject6" name="subjects">
                                            <label class="form-check-label" for="subject6">Art</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="Music" id="subject7" name="subjects">
                                            <label class="form-check-label" for="subject7">Music</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="Physical Education" id="subject8" name="subjects">
                                            <label class="form-check-label" for="subject8">Physical Education</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="Computer Science" id="subject9" name="subjects">
                                            <label class="form-check-label" for="subject9">Computer Science</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="text-center">
                        <button type="button" class="btn btn-outline-secondary me-3" onclick="previousStep()">
                            <i class="fas fa-arrow-left me-2"></i> Back
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep()">
                            Continue <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Plan Selection (for teachers only) -->
                <div id="step3-content" class="step-content">
                    <div class="hero-section">
                        <h2 class="hero-title">Choose Your Plan</h2>
                        <p class="hero-subtitle">Select the plan that fits your needs</p>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="plan-card" onclick="selectPlan('basic')">
                                <div class="plan-name">Basic</div>
                                <div class="plan-price">Free</div>
                                <ul class="plan-features">
                                    <li><i class="fas fa-check"></i> Up to 50 students</li>
                                    <li><i class="fas fa-check"></i> 10 quizzes per month</li>
                                    <li><i class="fas fa-check"></i> 1 GB storage</li>
                                    <li><i class="fas fa-check"></i> Basic analytics</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="plan-card" onclick="selectPlan('pro')">
                                <div class="plan-name">Professional</div>
                                <div class="plan-price">$19/month</div>
                                <ul class="plan-features">
                                    <li><i class="fas fa-check"></i> Up to 200 students</li>
                                    <li><i class="fas fa-check"></i> Unlimited quizzes</li>
                                    <li><i class="fas fa-check"></i> 10 GB storage</li>
                                    <li><i class="fas fa-check"></i> Advanced analytics</li>
                                    <li><i class="fas fa-check"></i> Multi-language support</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="plan-card" onclick="selectPlan('enterprise')">
                                <div class="plan-name">Enterprise</div>
                                <div class="plan-price">$49/month</div>
                                <ul class="plan-features">
                                    <li><i class="fas fa-check"></i> Unlimited students</li>
                                    <li><i class="fas fa-check"></i> Unlimited quizzes</li>
                                    <li><i class="fas fa-check"></i> 100 GB storage</li>
                                    <li><i class="fas fa-check"></i> Advanced analytics</li>
                                    <li><i class="fas fa-check"></i> Multi-language support</li>
                                    <li><i class="fas fa-check"></i> Custom branding</li>
                                    <li><i class="fas fa-check"></i> API access</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="button" class="btn btn-outline-secondary me-3" onclick="previousStep()">
                            <i class="fas fa-arrow-left me-2"></i> Back
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep()">
                            Continue <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 4: Review & Create -->
                <div id="step4-content" class="step-content">
                    <div class="hero-section">
                        <h2 class="hero-title">Review & Create</h2>
                        <p class="hero-subtitle">Almost there! Review your information</p>
                    </div>

                    <div id="reviewInfo">
                        <!-- Dynamic content will be populated here -->
                    </div>

                    <div class="text-center">
                        <button type="button" class="btn btn-outline-secondary me-3" onclick="previousStep()">
                            <i class="fas fa-arrow-left me-2"></i> Back
                        </button>
                        <button type="button" class="btn btn-primary" onclick="createAccount()" id="createBtn">
                            <i class="fas fa-rocket me-2"></i> Create Account
                        </button>
                    </div>

                    <div class="text-center mt-3">
                        <small class="text-muted">
                            By creating an account, you agree to our Terms of Service and Privacy Policy
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 1;
        let userType = '';
        let selectedPlan = 'basic';

        function selectUserType(type) {
            userType = type;

            // Remove selected class from both cards
            document.getElementById('teacher-card').classList.remove('selected');
            document.getElementById('student-card').classList.remove('selected');

            // Add selected class to chosen card
            document.getElementById(type + '-card').classList.add('selected');

            // Enable next button
            document.getElementById('userTypeNext').disabled = false;
        }

        function nextStep() {
            if (currentStep === 1) {
                if (!userType) {
                    alert('Please select whether you are a teacher or student');
                    return;
                }

                // Show appropriate form for step 2
                if (userType === 'teacher') {
                    document.getElementById('organizationForm').classList.add('active');
                    document.getElementById('studentForm').classList.remove('active');
                } else {
                    document.getElementById('organizationForm').classList.remove('active');
                    document.getElementById('studentForm').classList.add('active');
                    // Skip plan selection for students
                    document.getElementById('step3').style.display = 'none';
                }
            }

            if (currentStep === 2) {
                if (userType === 'teacher') {
                    // Validate organization form
                    const form = document.getElementById('step2-form');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }

                    // Check subdomain availability
                    checkSubdomainAvailability();
                } else {
                    // Validate student form
                    const form = document.getElementById('student-form');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }

                    // For students, skip plan selection and go to review
                    currentStep = 3; // Will be incremented to 4 below
                }
            }

            if (currentStep === 3 && userType === 'teacher') {
                if (!selectedPlan) {
                    alert('Please select a plan');
                    return;
                }
            }

            // Move to next step
            document.getElementById(`step${currentStep}-content`).classList.remove('active');
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${currentStep}`).classList.add('completed');

            currentStep++;

            document.getElementById(`step${currentStep}-content`).classList.add('active');
            document.getElementById(`step${currentStep}`).classList.add('active');

            // Update review page
            if (currentStep === 4) {
                updateReviewPage();
            }
        }

        function previousStep() {
            if (currentStep === 1) return;

            document.getElementById(`step${currentStep}-content`).classList.remove('active');
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${currentStep}`).classList.add('pending');

            // Handle step 3 visibility for students
            if (currentStep === 4 && userType === 'student') {
                currentStep = 2; // Skip plan selection
            } else {
                currentStep--;
            }

            document.getElementById(`step${currentStep}-content`).classList.add('active');
            document.getElementById(`step${currentStep}`).classList.remove('completed');
            document.getElementById(`step${currentStep}`).classList.add('active');

            // Show step 3 for teachers
            if (userType === 'teacher') {
                document.getElementById('step3').style.display = 'flex';
            }
        }

        function selectPlan(plan) {
            selectedPlan = plan;

            // Remove selected class from all plan cards
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Add selected class to chosen plan
            event.target.closest('.plan-card').classList.add('selected');
        }

        function updateSubdomainPreview() {
            const subdomain = document.getElementById('subdomain').value;
            const preview = document.getElementById('subdomainPreview');
            if (subdomain) {
                preview.textContent = `https://${subdomain}.skillons.com`;
            } else {
                preview.textContent = 'https://your-school.skillons.com';
            }
        }

        function checkSubdomainAvailability() {
            const subdomain = document.getElementById('subdomain').value;
            if (!subdomain) return;

            fetch(`/api/check-subdomain/${subdomain}`, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.available) {
                    alert('This subdomain is already taken. Please choose another one.');
                    return;
                }
                // Continue to next step if available
            })
            .catch(error => {
                console.error('Error checking subdomain:', error);
            });
        }

        function updateReviewPage() {
            const reviewDiv = document.getElementById('reviewInfo');
            let reviewHTML = '';

            if (userType === 'teacher') {
                const orgName = document.getElementById('organizationName').value;
                const subdomain = document.getElementById('subdomain').value;
                const teacherName = document.getElementById('teacherName').value;
                const email = document.getElementById('email').value;
                const planNames = { basic: 'Basic (Free)', pro: 'Professional ($19/month)', enterprise: 'Enterprise ($49/month)' };

                reviewHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Organization Details</h5>
                            <p><strong>Organization:</strong> ${orgName}</p>
                            <p><strong>Subdomain:</strong> ${subdomain}.skillons.com</p>
                            <p><strong>Your Name:</strong> ${teacherName}</p>
                            <p><strong>Email:</strong> ${email}</p>
                            <p><strong>Plan:</strong> ${planNames[selectedPlan]}</p>
                        </div>
                    </div>
                `;
            } else {
                const studentName = document.getElementById('studentName').value;
                const studentEmail = document.getElementById('studentEmail').value;
                const gradeLevel = document.getElementById('gradeLevel').value;
                
                // Get organization info from either select box or manual input
                const selectFromList = document.getElementById('selectFromList').checked;
                let orgDisplayNames = [];
                
                if (selectFromList) {
                    const selectElement = document.getElementById('organizationSelect');
                    orgDisplayNames = Array.from(selectElement.selectedOptions).map(option => option.text);
                } else {
                    const manualCodes = document.getElementById('organizationCodeManual').value;
                    orgDisplayNames = manualCodes.split(',').map(code => code.trim()).filter(code => code);
                }
                
                const orgDisplayText = orgDisplayNames.length > 0 ? orgDisplayNames.join(', ') : 'None selected';

                const subjects = Array.from(document.querySelectorAll('input[name="subjects"]:checked'))
                    .map(cb => cb.value);

                reviewHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Student Details</h5>
                            <p><strong>Your Name:</strong> ${studentName}</p>
                            <p><strong>Email:</strong> ${studentEmail}</p>
                            <p><strong>Grade Level:</strong> ${gradeLevel}</p>
                            <p><strong>Organizations:</strong> ${orgDisplayText}</p>
                            <p><strong>Subjects:</strong> ${subjects.length ? subjects.join(', ') : 'None selected'}</p>
                        </div>
                    </div>
                `;
            }

            reviewDiv.innerHTML = reviewHTML;
        }

        function toggleOrgSelection() {
            const selectFromList = document.getElementById('selectFromList').checked;
            const orgSelectBox = document.getElementById('orgSelectBox');
            const orgCodeInput = document.getElementById('orgCodeInput');
            const orgSelect = document.getElementById('organizationSelect');
            const orgCodeManual = document.getElementById('organizationCodeManual');
            const helpText = document.getElementById('orgHelpText');
            const manualCodeHelp = document.getElementById('manualCodeHelp');

            if (selectFromList) {
                orgSelectBox.style.display = 'block';
                orgCodeInput.style.display = 'none';
                manualCodeHelp.style.display = 'none';
                orgSelect.required = true;
                orgCodeManual.required = false;
                orgCodeManual.value = '';
                helpText.textContent = 'Select one or more organizations from the list (hold Ctrl/Cmd for multiple)';
            } else {
                orgSelectBox.style.display = 'none';
                orgCodeInput.style.display = 'block';
                manualCodeHelp.style.display = 'block';
                orgSelect.required = false;
                orgCodeManual.required = true;
                // Clear all selections
                Array.from(orgSelect.options).forEach(option => option.selected = false);
                helpText.textContent = 'Enter organization codes separated by commas for multiple organizations';
            }
        }

        function createAccount() {
            const createBtn = document.getElementById('createBtn');
            createBtn.disabled = true;
            createBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Creating...';

            if (userType === 'teacher') {
                createTeacherOrganization();
            } else {
                createStudentAccount();
            }
        }

        function createTeacherOrganization() {
            const formData = {
                organizationName: document.getElementById('organizationName').value,
                subdomain: document.getElementById('subdomain').value,
                teacherName: document.getElementById('teacherName').value,
                email: document.getElementById('email').value,
                bio: document.getElementById('bio').value,
                planType: selectedPlan
            };

            fetch('/api/create-organization', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Organization created successfully! Please sign in with Google to complete setup.');
                    window.location.href = '/auth/google';
                } else {
                    alert('Error: ' + data.message);
                    resetCreateButton();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                resetCreateButton();
            });
        }

        function createStudentAccount() {
            const subjects = Array.from(document.querySelectorAll('input[name="subjects"]:checked'))
                .map(cb => cb.value);

            // Get organization codes from either select box or manual input
            const selectFromList = document.getElementById('selectFromList').checked;
            let organizationCodes;
            
            if (selectFromList) {
                // Get multiple selected values from the select box
                const selectElement = document.getElementById('organizationSelect');
                organizationCodes = Array.from(selectElement.selectedOptions).map(option => option.value);
            } else {
                // For manual entry, split by commas or use single code
                const manualCodes = document.getElementById('organizationCodeManual').value;
                organizationCodes = manualCodes.split(',').map(code => code.trim()).filter(code => code);
            }

            const formData = {
                studentName: document.getElementById('studentName').value,
                email: document.getElementById('studentEmail').value,
                gradeLevel: document.getElementById('gradeLevel').value,
                organizationCodes: organizationCodes,
                subjects: subjects
            };

            fetch('/api/create-student-account', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Student account created successfully! Please sign in with Google to access your dashboard.');
                    window.location.href = '/auth/google';
                } else {
                    alert('Error: ' + data.message);
                    resetCreateButton();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                resetCreateButton();
            });
        }

        function resetCreateButton() {
            const createBtn = document.getElementById('createBtn');
            createBtn.disabled = false;
            createBtn.innerHTML = '<i class="fas fa-rocket me-2"></i> Create Account';
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('subdomain').addEventListener('input', updateSubdomainPreview);

            // Handle URL parameters for error messages
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            if (error) {
                alert(decodeURIComponent(error));
            }
        });
    </script>
</body>
</html>
